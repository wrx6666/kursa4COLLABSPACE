{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Название Проекта</title>
  <link rel="stylesheet" href="{% static 'css/main.css' %}?v=6">
  {% block extra_head %}{% endblock %}
</head>
<body class="min-h-screen text-ink bg-bg">
  <header class="sticky top-0 z-20 border-b border-border bg-bg/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-2 flex items-center gap-4">
      <a href="{% url 'home' %}" class="text-lg font-semibold text-transparent bg-clip-text bg-gradient-to-r from-accent-blue to-accent-link leading-tight">
        Название Проекта
      </a>
      <div class="flex-1 flex justify-center">
        <form method="get" action="{% url 'home' %}" class="flex items-center gap-2 w-full max-w-[500px]">
          <div class="flex-1 flex items-center bg-bgElevated border border-border rounded-btn px-3 py-1.5 gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-inkMuted flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 105.5 5.5a7.5 7.5 0 0011.15 11.15z" />
            </svg>
            {{ search_form.search }}
          </div>
          
          <!-- Кнопка фильтров -->
          <div class="relative">
            <button 
              type="button" 
              onclick="toggleSearchFilters()"
              class="btn-outline px-3 py-1.5 font-semibold flex items-center gap-2 text-sm"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              {% if has_active_filters %}
                <span class="w-2 h-2 bg-accent-blue rounded-full"></span>
              {% endif %}
            </button>
            
            <!-- Выпадающая панель фильтров -->
            <div 
              id="search-filters-dropdown" 
              class="hidden absolute right-0 mt-2 w-80 rounded-btn bg-bgElevated border border-border shadow-card z-30 p-4 space-y-4"
            >
              <!-- Фильтр по разделу -->
              <div>
                <label for="{{ search_form.section.id_for_label }}" class="block text-sm font-semibold text-ink mb-2">
                  {{ search_form.section.label }}
                </label>
                {{ search_form.section }}
                {% if search_form.section.errors %}
                  <div class="mt-1 text-sm text-danger">
                    {{ search_form.section.errors }}
                  </div>
                {% endif %}
              </div>
              
              <!-- Фильтр по тегам -->
              <div>
                <label class="block text-sm font-semibold text-ink mb-2">
                  {{ search_form.tags.label }}
                </label>
                <div class="max-h-64 overflow-y-auto border border-border rounded-btn bg-bg p-3 space-y-2">
                  {{ search_form.tags }}
                </div>
                {% if search_form.tags.errors %}
                  <div class="mt-1 text-sm text-danger">
                    {{ search_form.tags.errors }}
                  </div>
                {% endif %}
                {% if search_form.tags.help_text %}
                  <p class="mt-1 text-xs text-inkMuted">{{ search_form.tags.help_text }}</p>
                {% endif %}
              </div>
              
              <!-- Кнопки действий -->
              <div class="flex items-center gap-2 pt-2 border-t border-border">
                <button type="submit" class="btn-primary flex-1 px-4 py-2 text-sm font-semibold">
                  Применить
                </button>
                <a href="{% url 'home' %}" class="btn-outline px-4 py-2 text-sm font-semibold">
                  Сбросить
                </a>
              </div>
            </div>
          </div>
          
          <!-- Кнопка поиска -->
          <button type="submit" class="btn-primary px-4 py-1.5 font-semibold text-sm">
            Найти
          </button>
        </form>
      </div>
            <div class="ml-2 flex items-center gap-3">
              {% if user.is_authenticated %}
                <!-- Иконка уведомлений -->
                <div class="relative">
                  <a href="{% url 'notifications' %}" class="relative flex items-center justify-center w-10 h-10 rounded-full border-2 border-border bg-bgElevated hover:border-accent-blue transition-colors">
                    <svg class="w-5 h-5 text-ink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    {% if unread_notifications_count > 0 %}
                      <span class="absolute -top-1 -right-1 w-5 h-5 bg-danger rounded-full flex items-center justify-center text-xs font-semibold text-white">
                        {{ unread_notifications_count }}
                      </span>
                    {% endif %}
                  </a>
                </div>
                
                <!-- Выпадающее меню с аватаркой -->
          <div class="relative" id="user-menu-container">
            <button 
              type="button" 
              id="user-menu-button" 
              class="flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-accent-blue rounded-full transition-all"
              aria-expanded="false"
              aria-haspopup="true"
            >
              <div class="w-10 h-10 rounded-full border-2 border-border overflow-hidden bg-bgElevated hover:border-accent-blue transition-colors">
                {% if user.profile %}
                  {% if user.profile.avatar_file %}
                    <img src="{{ user.profile.avatar_file.url }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                  {% elif user.profile.avatar_url %}
                    <img src="{{ user.profile.avatar_url }}" alt="{{ user.username }}" class="w-full h-full object-cover">
                  {% else %}
                    <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ user.username }}" class="w-full h-full object-cover">
                  {% endif %}
                {% else %}
                  <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ user.username }}" class="w-full h-full object-cover">
                {% endif %}
              </div>
              <svg class="w-4 h-4 text-inkMuted transition-transform" id="user-menu-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- Выпадающее меню -->
            <div 
              id="user-menu-dropdown" 
              class="hidden absolute right-0 mt-2 w-56 rounded-btn bg-bgElevated border border-border shadow-card z-30 overflow-hidden"
            >
              <div class="py-2">
                <!-- Информация о пользователе -->
                <div class="px-4 py-3 border-b border-border">
                  <div class="text-sm font-semibold text-ink">{{ user.username }}</div>
                  <div class="text-xs text-inkMuted mt-1">
                    {% if user.profile %}
                      {% if user.profile.role == 'author' %}
                        Автор
                      {% elif user.profile.role == 'admin' %}
                        Администратор
                      {% else %}
                        Пользователь
                      {% endif %}
                    {% else %}
                      Пользователь
                    {% endif %}
                  </div>
                </div>
                
                <!-- Создать проект (только для верифицированных авторов и админов) -->
                {% if user.profile %}
                  {% if user.profile.role == 'admin' or user.profile.role == 'author' and user.profile.verified %}
                <a 
                  href="{% url 'create_project' %}" 
                  class="block px-4 py-2 text-sm text-ink hover:bg-bg transition-colors"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Создать проект
                  </div>
                </a>
                  {% endif %}
                {% endif %}
                
                <!-- Уведомления -->
                <a 
                  href="{% url 'notifications' %}" 
                  class="block px-4 py-2 text-sm text-ink hover:bg-bg transition-colors relative"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    Уведомления
                    {% if unread_notifications_count > 0 %}
                      <span class="ml-auto px-2 py-0.5 bg-danger rounded-full text-xs font-semibold text-white">
                        {{ unread_notifications_count }}
                      </span>
                    {% endif %}
                  </div>
                </a>
                
                <!-- Мне понравилось -->
                <a 
                  href="{% url 'profile' %}?tab=favorites" 
                  class="block px-4 py-2 text-sm text-ink hover:bg-bg transition-colors"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                    Мне понравилось
                  </div>
                </a>
                
                <!-- Мои проекты (показываем, если пользователь владелец или участник проекта) -->
                {% if user.projects.all or user.project_participations.all %}
                <a 
                  href="{% url 'profile' %}?tab=projects" 
                  class="block px-4 py-2 text-sm text-ink hover:bg-bg transition-colors"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    Мои проекты
                  </div>
                </a>
                {% endif %}
                
                <!-- Профиль -->
                <a 
                  href="{% url 'profile' %}" 
                  class="block px-4 py-2 text-sm text-ink hover:bg-bg transition-colors"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    Профиль
                  </div>
                </a>
                
                <!-- Разделитель -->
                <div class="border-t border-border my-1"></div>
                
                <!-- Выйти -->
                <a 
                  href="{% url 'logout' %}" 
                  class="block px-4 py-2 text-sm text-danger hover:bg-danger/10 transition-colors"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    Выйти
                  </div>
                </a>
              </div>
            </div>
          </div>
        {% else %}
          <a href="#" class="text-xs sm:text-sm btn-outline px-3 py-2">Обратная связь</a>
          <a href="{% url 'login' %}" class="text-xs sm:text-sm btn-dark px-3 py-2">Войти</a>
          <a href="{% url 'signup' %}" class="text-xs sm:text-sm btn-primary px-4 py-2">Регистрация</a>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Контейнер для всплывающих уведомлений -->
  <div id="notifications-container" class="fixed top-20 right-4 z-50 space-y-3 max-w-md"></div>

  <main class="{% block main_class %}max-w-5xl mx-auto px-6 py-10{% endblock %}">
    {% block content %}{% endblock %}
  </main>

  <script>
    // Функция для управления выпадающим меню фильтров поиска (глобальная)  
    window.toggleSearchFilters = function() {
      const filtersDropdown = document.getElementById('search-filters-dropdown');
      if (filtersDropdown) {
        filtersDropdown.classList.toggle('hidden');
      }
    };
    
    // Функция для создания и отображения всплывающего уведомления
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notifications-container');
      if (!container) return;

      // Определяем стили в зависимости от типа
      const typeStyles = {
        'success': 'bg-success/20 text-success border-success/30',
        'error': 'bg-danger/20 text-danger border-danger/30',
        'warning': 'bg-warning/20 text-warning border-warning/30',
        'info': 'bg-inkMuted/20 text-inkMuted border-inkMuted/30'
      };

      const style = typeStyles[type] || typeStyles['info'];

      // Создаем элемент уведомления
      const notification = document.createElement('div');
      notification.className = `notification-toast glass-panel p-4 rounded-btn border ${style} text-sm font-medium shadow-card transform transition-all duration-300 ease-in-out opacity-0 translate-x-full`;
      notification.textContent = message;

      // Добавляем в контейнер
      container.appendChild(notification);

      // Запускаем анимацию появления
      setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-full');
        notification.classList.add('opacity-100', 'translate-x-0');
      }, 10);

      // Автоматически скрываем через 4 секунды
      setTimeout(() => {
        notification.classList.remove('opacity-100', 'translate-x-0');
        notification.classList.add('opacity-0', 'translate-x-full');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 4000);
    }

    // Обработка Django messages при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
      // Находим все сообщения Django на странице
      const messageContainers = document.querySelectorAll('[data-django-message]');
      messageContainers.forEach(container => {
        const message = container.textContent.trim();
        const type = container.getAttribute('data-django-message') || 'info';
        showNotification(message, type);
        // Скрываем оригинальное сообщение
        container.style.display = 'none';
      });

      // Управление выпадающим меню пользователя
      const userMenuButton = document.getElementById('user-menu-button');
      const userMenuDropdown = document.getElementById('user-menu-dropdown');
      const userMenuArrow = document.getElementById('user-menu-arrow');
      
      if (userMenuButton && userMenuDropdown) {
        // Открытие/закрытие меню при клике на аватарку
        userMenuButton.addEventListener('click', function(e) {
          e.stopPropagation();
          const isHidden = userMenuDropdown.classList.contains('hidden');
          
          if (isHidden) {
            userMenuDropdown.classList.remove('hidden');
            userMenuArrow.classList.add('rotate-180');
            userMenuButton.setAttribute('aria-expanded', 'true');
          } else {
            userMenuDropdown.classList.add('hidden');
            userMenuArrow.classList.remove('rotate-180');
            userMenuButton.setAttribute('aria-expanded', 'false');
          }
        });

        // Закрытие меню при клике вне его
        document.addEventListener('click', function(e) {
          const container = document.getElementById('user-menu-container');
          if (container && !container.contains(e.target)) {
            userMenuDropdown.classList.add('hidden');
            userMenuArrow.classList.remove('rotate-180');
            userMenuButton.setAttribute('aria-expanded', 'false');
          }
        });

        // Закрытие меню при нажатии Escape
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && !userMenuDropdown.classList.contains('hidden')) {
            userMenuDropdown.classList.add('hidden');
            userMenuArrow.classList.remove('rotate-180');
            userMenuButton.setAttribute('aria-expanded', 'false');
          }
        });
      }
      
      // Закрытие выпадающего меню фильтров при клике вне его
      document.addEventListener('click', function(e) {
        const filtersButton = e.target.closest('[onclick="toggleSearchFilters()"]');
        const filtersDropdown = document.getElementById('search-filters-dropdown');
        
        if (!filtersButton && filtersDropdown && !filtersDropdown.contains(e.target)) {
          filtersDropdown.classList.add('hidden');
        }
      });
      
      // Закрытие фильтров при нажатии Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const filtersDropdown = document.getElementById('search-filters-dropdown');
          if (filtersDropdown && !filtersDropdown.classList.contains('hidden')) {
            filtersDropdown.classList.add('hidden');
          }
        }
      });
    });
  </script>
  
  <style>
    /* Liquid Glass эффект для карточек */
    .liquid-glass-card {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.05) 100%
      );
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.37),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .liquid-glass-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
      );
      opacity: 0.6;
    }
    
    .liquid-glass-card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 12px 40px 0 rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.25),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        0 0 20px rgba(77, 163, 255, 0.15);
      border-color: rgba(77, 163, 255, 0.3);
    }
    
    .liquid-glass-card:active {
      transform: translateY(-2px);
    }
    
    /* Liquid Glass для панелей (без hover эффекта) */
    .liquid-glass-panel {
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.05) 100%
      );
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 
        0 8px 32px 0 rgba(0, 0, 0, 0.37),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }
    
    .liquid-glass-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
      );
      opacity: 0.6;
    }
  </style>
</body>
</html>

