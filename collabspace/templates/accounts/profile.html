{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<style>
  .hero-profile-bg {
    background-image: linear-gradient(180deg, rgba(11,13,19,0.35), rgba(11,13,19,0.75)), url("/static/img/register-hero.jpg");
    background-size: cover;
    background-position: center;
  }
</style>
{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-2 md:px-6 py-6 space-y-6">

  <!-- Hero + Avatar -->
  <div class="relative overflow-hidden rounded-card border border-border shadow-card" style="min-height: 220px;">
    <div class="absolute inset-0 hero-profile-bg"></div>
    <div class="relative flex flex-col md:flex-row items-start md:items-end gap-4 md:gap-8 p-6 md:p-8">
      <div class="w-28 h-28 rounded-full border-2 border-border overflow-hidden bg-bgElevated">
        {% if profile.avatar_file %}
          <img src="{{ profile.avatar_file.url }}" alt="avatar" class="w-full h-full object-cover">
        {% elif profile.avatar_url %}
          <img src="{{ profile.avatar_url }}" alt="avatar" class="w-full h-full object-cover">
        {% else %}
          <img src="{% static 'img/avatar-placeholder.png' %}" alt="avatar" class="w-full h-full object-cover">
        {% endif %}
      </div>
      <div class="flex-1 flex items-end justify-between">
        <div class="space-y-1 text-white">
          <div class="flex items-center gap-2">
            <div class="text-2xl font-semibold">{{ user.username }}</div>
            {% if profile.role == 'author' %}
              {% if profile.verified %}
                <svg class="w-6 h-6 text-accent-blue" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              {% else %}
                <svg class="w-6 h-6 text-inkMuted" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              {% endif %}
            {% elif profile.role == 'admin' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-btn bg-accent-purple/20 text-accent-purple border border-accent-purple/30">Админ</span>
            {% endif %}
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span class="text-inkMuted">Дата регистрации: {{ user.date_joined|date:"d.m.Y" }}</span>
            <span class="text-inkMuted">•</span>
            <span class="{{ profile.get_role_display_class }} font-medium">{{ profile.get_role_display }}</span>
          </div>
          {% if profile.role == 'author' and not profile.verified %}
            <div class="mt-2 px-3 py-2 rounded-btn bg-warning/20 text-warning border border-warning/30 text-xs">
              ⚠️ Ваш аккаунт автора ожидает верификации. Вы не сможете создавать проекты до подтверждения администратором.
            </div>
          {% endif %}
        </div>
        <a href="{% url 'profile_edit' %}" class="btn-outline px-4 py-2 text-sm font-semibold">Настройки профиля</a>
      </div>
    </div>
  </div>

  <!-- Вкладки -->
  <div class="glass-panel p-4">
    <div class="flex gap-2 border-b border-border mb-4">
      <a 
        href="{% url 'profile' %}?tab=info" 
        class="px-4 py-2 text-sm font-semibold {% if active_tab == 'info' %}text-ink border-b-2 border-accent-blue{% else %}text-inkMuted hover:text-ink{% endif %} transition-colors"
      >
        О себе
      </a>
      <a 
        href="{% url 'profile' %}?tab=favorites" 
        class="px-4 py-2 text-sm font-semibold {% if active_tab == 'favorites' %}text-ink border-b-2 border-accent-blue{% else %}text-inkMuted hover:text-ink{% endif %} transition-colors"
      >
        Мне понравилось ({{ favorite_projects|length }})
      </a>
      <a 
        href="{% url 'profile' %}?tab=projects" 
        class="px-4 py-2 text-sm font-semibold {% if active_tab == 'projects' %}text-ink border-b-2 border-accent-blue{% else %}text-inkMuted hover:text-ink{% endif %} transition-colors"
      >
        Мои проекты ({{ total_projects_count }})
      </a>
      <a 
        href="{% url 'profile' %}?tab=invitations" 
        class="px-4 py-2 text-sm font-semibold {% if active_tab == 'invitations' %}text-ink border-b-2 border-accent-blue{% else %}text-inkMuted hover:text-ink{% endif %} transition-colors relative"
      >
        Приглашения
        {% if pending_invitations|length > 0 %}
          <span class="absolute top-1 right-1 w-2 h-2 bg-accent-blue rounded-full"></span>
        {% endif %}
        ({{ pending_invitations|length }})
      </a>
    </div>

    <!-- Содержимое вкладок -->
    {% if active_tab == 'info' %}
      <!-- Bio Section -->
      <div class="space-y-3">
        <div class="font-semibold text-ink">О себе</div>
        {% if profile.bio %}
          <div class="text-ink whitespace-pre-wrap">{{ profile.bio }}</div>
        {% else %}
          <div class="text-inkMuted italic">Пока нет информации о себе.</div>
        {% endif %}
      </div>
    {% elif active_tab == 'favorites' %}
      <!-- Понравившиеся проекты -->
      <div class="space-y-4">
        <div class="font-semibold text-ink">Мне понравилось</div>
        {% if favorite_projects %}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for project in favorite_projects %}
              <a href="{% url 'project_detail' project.pk %}" class="liquid-glass-card p-4 rounded-btn block">
                {% if project.image_file %}
                  <div class="w-full h-48 rounded-btn overflow-hidden mb-3 bg-bgElevated">
                    <img src="{{ project.image_file.url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
                  </div>
                {% elif project.image_url %}
                  <div class="w-full h-48 rounded-btn overflow-hidden mb-3 bg-bgElevated">
                    <img src="{{ project.image_url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
                  </div>
                {% else %}
                  <div class="w-full h-48 rounded-btn bg-bgElevated border border-border mb-3 flex items-center justify-center">
                    <span class="text-inkMuted text-sm">Нет изображения</span>
                  </div>
                {% endif %}
                <h3 class="text-lg font-semibold text-ink mb-2 line-clamp-2">{{ project.title }}</h3>
                <p class="text-sm text-inkMuted line-clamp-2">{{ project.description|truncatewords:15 }}</p>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-8 text-inkMuted">
            <p>У вас пока нет понравившихся проектов.</p>
          </div>
        {% endif %}
      </div>
    {% elif active_tab == 'projects' %}
      <!-- Мои проекты -->
      <div class="space-y-6">
        <!-- Проекты, где пользователь владелец -->
        {% if my_projects %}
          <div>
            <div class="font-semibold text-ink mb-4">Мои проекты ({{ my_projects|length }})</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for project in my_projects %}
                <a href="{% url 'project_detail' project.pk %}" class="liquid-glass-card p-4 rounded-btn block">
                  {% if project.image_file %}
                    <div class="w-full h-48 rounded-btn overflow-hidden mb-3 bg-bgElevated">
                      <img src="{{ project.image_file.url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
                    </div>
                  {% elif project.image_url %}
                    <div class="w-full h-48 rounded-btn overflow-hidden mb-3 bg-bgElevated">
                      <img src="{{ project.image_url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
                    </div>
                  {% else %}
                    <div class="w-full h-48 rounded-btn bg-bgElevated border border-border mb-3 flex items-center justify-center">
                      <span class="text-inkMuted text-sm">Нет изображения</span>
                    </div>
                  {% endif %}
                  <h3 class="text-lg font-semibold text-ink mb-2 line-clamp-2">{{ project.title }}</h3>
                  <p class="text-sm text-inkMuted line-clamp-2">{{ project.description|truncatewords:15 }}</p>
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <!-- Проекты, где пользователь участник -->
        {% if participant_projects %}
          <div>
            <div class="font-semibold text-ink mb-4">Проекты, где я участник ({{ participant_projects|length }})</div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for project in participant_projects %}
                <a href="{% url 'project_detail' project.pk %}" class="liquid-glass-card p-4 rounded-btn block">
                  {% if project.image_file %}
                    <div class="w-full h-48 rounded-btn overflow-hidden mb-3 bg-bgElevated">
                      <img src="{{ project.image_file.url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
                    </div>
                  {% elif project.image_url %}
                    <div class="w-full h-48 rounded-btn overflow-hidden mb-3 bg-bgElevated">
                      <img src="{{ project.image_url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
                    </div>
                  {% else %}
                    <div class="w-full h-48 rounded-btn bg-bgElevated border border-border mb-3 flex items-center justify-center">
                      <span class="text-inkMuted text-sm">Нет изображения</span>
                    </div>
                  {% endif %}
                  <h3 class="text-lg font-semibold text-ink mb-2 line-clamp-2">{{ project.title }}</h3>
                  <p class="text-sm text-inkMuted line-clamp-2">{{ project.description|truncatewords:15 }}</p>
                </a>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if not my_projects and not participant_projects %}
          <div class="text-center py-8 text-inkMuted">
            <p>У вас пока нет проектов.</p>
          </div>
        {% endif %}
      </div>
    {% elif active_tab == 'invitations' %}
      <!-- Приглашения в проекты -->
      <div class="space-y-4">
        <div class="font-semibold text-ink">Приглашения в проекты</div>
        {% if pending_invitations %}
          <div class="space-y-3">
            {% for invitation in pending_invitations %}
              <div class="glass-panel p-4 border border-border hover:border-accent-blue transition-colors">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      {% if invitation.project.image_file %}
                        <div class="w-16 h-16 rounded-btn overflow-hidden bg-bgElevated flex-shrink-0">
                          <img src="{{ invitation.project.image_file.url }}" alt="{{ invitation.project.title }}" class="w-full h-full object-cover">
                        </div>
                      {% elif invitation.project.image_url %}
                        <div class="w-16 h-16 rounded-btn overflow-hidden bg-bgElevated flex-shrink-0">
                          <img src="{{ invitation.project.image_url }}" alt="{{ invitation.project.title }}" class="w-full h-full object-cover">
                        </div>
                      {% else %}
                        <div class="w-16 h-16 rounded-btn bg-bgElevated border border-border flex items-center justify-center flex-shrink-0">
                          <span class="text-inkMuted text-xs">Нет изображения</span>
                        </div>
                      {% endif %}
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-ink mb-1">
                          <a href="{% url 'project_detail' invitation.project.pk %}" class="hover:text-accent-blue">
                            {{ invitation.project.title }}
                          </a>
                        </h3>
                        <p class="text-sm text-inkMuted mb-2">{{ invitation.project.description|truncatewords:20 }}</p>
                        <div class="flex items-center gap-2 text-xs text-inkMuted">
                          <span>Пригласил: <span class="text-ink font-medium">{{ invitation.invited_by.username }}</span></span>
                          <span>•</span>
                          <span>{{ invitation.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="flex gap-2 flex-shrink-0">
                    <a 
                      href="{% url 'accept_invitation' invitation.pk %}" 
                      class="btn-primary px-4 py-2 text-sm font-semibold whitespace-nowrap"
                      onclick="return confirm('Вы уверены, что хотите принять приглашение в проект &quot;{{ invitation.project.title }}&quot;?')"
                    >
                      Принять
                    </a>
                    <a 
                      href="{% url 'reject_invitation' invitation.pk %}" 
                      class="btn-outline px-4 py-2 text-sm font-semibold whitespace-nowrap"
                      onclick="return confirm('Вы уверены, что хотите отклонить приглашение в проект &quot;{{ invitation.project.title }}&quot;?')"
                    >
                      Отклонить
                    </a>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-8 text-inkMuted">
            <p>У вас пока нет приглашений в проекты.</p>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}