{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto px-2 md:px-6 py-10 space-y-6">
  
  {% if messages %}
    <div class="space-y-2" style="display: none;">
      {% for message in messages %}
        <div data-django-message="{{ message.tags|default:'info' }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
  
  <!-- Основной блок: изображение + информация -->
  <div class="liquid-glass-panel p-6 md:p-8 rounded-btn">
    <div class="flex flex-col md:flex-row gap-6 md:gap-8">
      <!-- Квадратное изображение слева -->
      <div class="flex-shrink-0">
        {% if project.image_file %}
          <div class="project-image-square">
            <img src="{{ project.image_file.url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
          </div>
        {% elif project.image_url %}
          <div class="project-image-square">
            <img src="{{ project.image_url }}" alt="{{ project.title }}" class="w-full h-full object-cover">
          </div>
        {% else %}
          <div class="project-image-square bg-bgElevated border border-border flex items-center justify-center">
            <span class="text-inkMuted text-sm">Нет изображения</span>
          </div>
        {% endif %}
      </div>

      <!-- Информация справа -->
      <div class="flex-1 flex flex-col">
        <!-- Кнопки справа вверху -->
        {% if user.is_authenticated %}
        <div class="flex justify-end gap-3 mb-4">
          {% if can_edit %}
            <a href="{% url 'edit_project' project.pk %}" class="btn-outline flex items-center gap-2 px-4 py-2 rounded-btn border border-border bg-bgElevated hover:bg-bgElevated/80 transition-colors text-sm font-semibold">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              Редактировать
            </a>
          {% endif %}
          <form method="post" action="{% url 'toggle_favorite' project.pk %}" class="inline">
            {% csrf_token %}
            <button 
              type="submit" 
              class="btn-favorite flex items-center gap-2 px-4 py-2 rounded-btn border border-border bg-bgElevated hover:bg-bgElevated/80 transition-colors {% if is_favorite %}text-danger{% endif %}"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 {% if is_favorite %}fill-current{% else %}text-inkMuted{% endif %}" fill="{% if is_favorite %}currentColor{% else %}none{% endif %}" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
              <span class="text-sm font-semibold">
                {% if is_favorite %}
                  Удалить из понравившихся
                {% else %}
                  Добавить в понравившиеся
                {% endif %}
              </span>
            </button>
          </form>
        </div>
        {% endif %}

        <!-- Теги (если есть) -->
        {% if project.get_tags_display_list %}
        <div class="flex flex-wrap gap-2 mb-4">
          {% for tag in project.get_tags_display_list %}
            <span class="px-3 py-1 rounded-btn bg-bgElevated border border-border text-sm text-inkMuted">
              {{ tag }}
            </span>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Название проекта -->
        <h1 class="text-4xl md:text-5xl font-bold text-ink mb-4 uppercase">{{ project.title }}</h1>

        <!-- Авторы и участники проекта -->
        <div class="space-y-2 mb-6">
          <div class="flex items-center gap-3 flex-wrap">
            <!-- Владелец проекта -->
            <div class="flex items-center gap-2">
              <div class="author-avatar-small owner-avatar-gold">
                {% if project.owner.profile.avatar_file %}
                  <img src="{{ project.owner.profile.avatar_file.url }}" alt="{{ project.owner.username }}">
                {% elif project.owner.profile.avatar_url %}
                  <img src="{{ project.owner.profile.avatar_url }}" alt="{{ project.owner.username }}">
                {% else %}
                  <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ project.owner.username }}">
                {% endif %}
              </div>
              <div class="flex items-center gap-2">
                <span class="text-ink font-semibold">
                  {{ project.owner.username }}
                </span>
                {% if project.owner.profile.role == 'author' %}
                  {% if project.owner.profile.verified %}
                    <svg class="w-5 h-5 text-accent-blue" fill="currentColor" viewBox="0 0 20 20" title="Верифицированный автор">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  {% endif %}
                {% elif project.owner.profile.role == 'admin' %}
                  <span class="text-accent-purple text-xs font-medium px-2 py-0.5 rounded-full bg-accent-purple/20">Админ</span>
                {% endif %}
              </div>
            </div>
            
            <!-- Участники проекта -->
            {% for participant in participants %}
            <div class="flex items-center gap-2">
              <div class="author-avatar-small">
                {% if participant.user.profile.avatar_file %}
                  <img src="{{ participant.user.profile.avatar_file.url }}" alt="{{ participant.user.username }}">
                {% elif participant.user.profile.avatar_url %}
                  <img src="{{ participant.user.profile.avatar_url }}" alt="{{ participant.user.username }}">
                {% else %}
                  <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ participant.user.username }}">
                {% endif %}
              </div>
              <div class="flex items-center gap-2">
                <span class="text-ink font-semibold">
                  {{ participant.user.username }}
                </span>
                {% if participant.user.profile.role == 'author' %}
                  {% if participant.user.profile.verified %}
                    <svg class="w-5 h-5 text-accent-blue" fill="currentColor" viewBox="0 0 20 20" title="Верифицированный автор">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  {% endif %}
                {% elif participant.user.profile.role == 'admin' %}
                  <span class="text-accent-purple text-xs font-medium px-2 py-0.5 rounded-full bg-accent-purple/20">Админ</span>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Описание проекта -->
  <div class="glass-panel p-6 md:p-8 space-y-4">
    <h2 class="text-xl font-semibold text-ink mb-3">Описание</h2>
    <div class="text-ink whitespace-pre-wrap">{{ project.description }}</div>
  </div>


  <!-- Задачи проекта -->
  <div class="glass-panel p-6 md:p-8 space-y-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-ink">Задачи проекта</h2>
      {% if user.is_authenticated and can_edit %}
        <a href="{% url 'create_task' project.pk %}" class="btn-primary px-4 py-2 text-sm font-semibold">
          + Создать задачу
        </a>
      {% endif %}
    </div>
    
    {% if tasks %}
      <div class="space-y-3">
        {% for task in tasks %}
          <div class="bg-bgElevated border border-border rounded-btn p-4 {% if task.is_overdue %}border-danger/50{% endif %}">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="text-lg font-semibold text-ink">{{ task.title }}</h3>
                  <span class="px-2 py-1 rounded-btn text-xs font-medium
                    {% if task.status == 'new' %}bg-accent-blue/20 text-accent-blue
                    {% elif task.status == 'in_progress' %}bg-accent-yellow/20 text-accent-yellow
                    {% elif task.status == 'completed' %}bg-accent-green/20 text-accent-green
                    {% elif task.status == 'cancelled' %}bg-inkMuted/20 text-inkMuted
                    {% endif %}">
                    {{ task.get_status_display }}
                  </span>
                  {% if task.is_overdue %}
                    <span class="px-2 py-1 rounded-btn text-xs font-medium bg-danger/20 text-danger">
                      Просрочена
                    </span>
                  {% endif %}
                </div>
                
                {% if task.description %}
                  <p class="text-inkMuted text-sm mb-3 whitespace-pre-wrap">{{ task.description }}</p>
                {% endif %}
                
                <div class="flex items-center gap-4 text-sm text-inkMuted flex-wrap">
                  {% if task.assignee %}
                    <div class="flex items-center gap-2">
                      <span>Исполнитель:</span>
                      <span class="text-ink font-medium">{{ task.assignee.username }}</span>
                    </div>
                  {% else %}
                    <span class="text-inkMuted">Исполнитель не назначен</span>
                  {% endif %}
                  
                  {% if task.deadline %}
                    <div class="flex items-center gap-2">
                      <span>Дедлайн:</span>
                      <span class="text-ink font-medium {% if task.is_overdue %}text-danger{% endif %}">
                        {{ task.deadline|date:"d.m.Y H:i" }}
                      </span>
                    </div>
                  {% endif %}
                  
                  <div class="flex items-center gap-2">
                    <span>Создал:</span>
                    <span class="text-ink font-medium">{{ task.created_by.username }}</span>
                  </div>
                </div>
              </div>
              
                  {% if user.is_authenticated and can_edit %}
                <div class="flex items-center gap-2">
                  <a href="{% url 'edit_task' project.pk task.pk %}" 
                     class="px-3 py-1.5 rounded-btn bg-bgElevated border border-border hover:bg-bgElevated/80 transition-colors text-sm">
                    Редактировать
                  </a>
                  <form method="post" action="{% url 'delete_task' project.pk task.pk %}" class="inline" 
                        onsubmit="return confirm('Вы уверены, что хотите удалить эту задачу?');">
                    {% csrf_token %}
                    <button type="submit" 
                            class="px-3 py-1.5 rounded-btn bg-danger/20 border border-danger/50 hover:bg-danger/30 transition-colors text-danger text-sm">
                      Удалить
                    </button>
                  </form>
                </div>
              {% endif %}
              
              <!-- Комментарии к задаче -->
              <div class="mt-4 pt-4 border-t border-border">
                <h4 class="text-sm font-semibold text-ink mb-3">Комментарии к задаче ({{ task.comments.count }})</h4>
                
                <!-- Форма добавления комментария к задаче -->
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'add_task_comment' project.pk task.pk %}" class="mb-4 space-y-3">
                  {% csrf_token %}
                  <div class="space-y-2">
                    <textarea 
                      name="text" 
                      class="w-full rounded-btn bg-bgElevated border border-border px-3 py-3 text-ink placeholder-inkMuted resize-none"
                      placeholder="Напишите комментарий к задаче..."
                      rows="3"
                      required
                    ></textarea>
                  </div>
                  <button type="submit" class="btn-primary px-4 py-2 text-sm font-semibold">
                    Отправить комментарий
                  </button>
                </form>
                {% else %}
                <div class="mb-4 p-3 rounded-btn bg-bgElevated border border-border text-sm text-inkMuted text-center">
                  <a href="{% url 'login' %}" class="text-accent-blue hover:underline">Войдите</a>, чтобы оставлять комментарии
                </div>
                {% endif %}
                
                <!-- Список комментариев к задаче -->
                <div class="space-y-3 mt-4">
                  {% if task.comments.all %}
                    {% for comment in task.comments.all %}
                      <div class="liquid-glass-panel p-3 rounded-btn border border-border">
                        <div class="flex items-start gap-3">
                          <div class="w-8 h-8 rounded-full border-2 border-border overflow-hidden bg-bgElevated flex-shrink-0">
                            {% if comment.author.profile %}
                              {% if comment.author.profile.avatar_file %}
                                <img src="{{ comment.author.profile.avatar_file.url }}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                              {% elif comment.author.profile.avatar_url %}
                                <img src="{{ comment.author.profile.avatar_url }}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                              {% else %}
                                <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                              {% endif %}
                            {% else %}
                              <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                            {% endif %}
                          </div>
                          <div class="flex-1 space-y-1">
                            <div class="flex items-center gap-2">
                              <span class="font-semibold text-ink text-sm">{{ comment.author.username }}</span>
                              <span class="text-xs text-inkMuted">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                            </div>
                            <div class="text-sm text-ink whitespace-pre-wrap">{{ comment.text }}</div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-center py-4 text-inkMuted text-sm">
                      <p>Пока нет комментариев к этой задаче.</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-8 text-inkMuted">
        <p>Задач пока нет. {% if can_edit %}Создайте первую задачу!{% endif %}</p>
      </div>
    {% endif %}
  </div>

  <!-- Комментарии -->
  <div class="glass-panel p-6 md:p-8 space-y-6">
    <h2 class="text-2xl font-semibold text-ink">Комментарии ({{ comments|length }})</h2>
    
    <!-- Форма добавления комментария -->
    {% if user.is_authenticated and comment_form %}
    <form method="post" action="{% url 'add_comment' project.pk %}" class="space-y-4">
      {% csrf_token %}
      <div class="space-y-2">
        <label for="{{ comment_form.text.id_for_label }}" class="text-sm font-semibold text-ink">
          {{ comment_form.text.label }}
        </label>
        {{ comment_form.text }}
        {% if comment_form.text.errors %}
          <div class="text-sm text-danger">{{ comment_form.text.errors }}</div>
        {% endif %}
      </div>
      <button type="submit" class="btn-primary px-6 py-3 font-semibold">
        Отправить комментарий
      </button>
    </form>
    {% elif not user.is_authenticated %}
    <div class="p-4 rounded-btn bg-bgElevated border border-border text-sm text-inkMuted text-center">
      <a href="{% url 'login' %}" class="text-accent-blue hover:underline">Войдите</a>, чтобы оставлять комментарии
    </div>
    {% endif %}
    
    <!-- Список комментариев -->
    <div class="space-y-4 mt-6">
      {% if comments %}
        {% for comment in comments %}
          <div class="liquid-glass-panel p-4 rounded-btn border border-border space-y-3">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 rounded-full border-2 border-border overflow-hidden bg-bgElevated flex-shrink-0">
                {% if comment.author.profile %}
                  {% if comment.author.profile.avatar_file %}
                    <img src="{{ comment.author.profile.avatar_file.url }}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                  {% elif comment.author.profile.avatar_url %}
                    <img src="{{ comment.author.profile.avatar_url }}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                  {% else %}
                    <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                  {% endif %}
                {% else %}
                  <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ comment.author.username }}" class="w-full h-full object-cover">
                {% endif %}
              </div>
              <div class="flex-1 space-y-2">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-ink">{{ comment.author.username }}</span>
                  <span class="text-xs text-inkMuted">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                <div class="text-ink whitespace-pre-wrap">{{ comment.text }}</div>
                
                <!-- Кнопка ответа (только для автора проекта) -->
                {% if user.is_authenticated and is_owner %}
                  <button 
                    type="button" 
                    onclick="toggleReplyForm('{{ comment.pk }}')"
                    class="text-sm text-accent-blue hover:text-accent-link transition-colors flex items-center gap-1"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                    Ответить
                  </button>
                  
                  <!-- Форма ответа (скрыта по умолчанию) -->
                  <div id="reply-form-{{ comment.pk }}" class="hidden mt-3 pl-4 border-l-2 border-border">
                    <form method="post" action="{% url 'add_reply' project.pk comment.pk %}" class="space-y-3">
                      {% csrf_token %}
                      <div class="space-y-2">
                        <label class="text-sm font-semibold text-ink">Ваш ответ</label>
                        <textarea 
                          name="text" 
                          class="w-full rounded-btn bg-bgElevated border border-border px-3 py-3 text-ink placeholder-inkMuted resize-none"
                          placeholder="Напишите ответ..."
                          rows="3"
                          required
                        ></textarea>
                      </div>
                      <div class="flex items-center gap-2">
                        <button type="submit" class="btn-primary px-4 py-2 text-sm font-semibold">
                          Отправить ответ
                        </button>
                        <button 
                          type="button" 
                          onclick="toggleReplyForm('{{ comment.pk }}')"
                          class="btn-outline px-4 py-2 text-sm font-semibold"
                        >
                          Отмена
                        </button>
                      </div>
                    </form>
                  </div>
                {% endif %}
              </div>
            </div>
            
            <!-- Ответы на комментарий -->
            {% if comment.replies.all %}
              <div class="ml-12 mt-3 space-y-3 border-l-2 border-border pl-4">
                {% for reply in comment.replies.all %}
                  <div class="liquid-glass-panel p-3 rounded-btn border border-border">
                    <div class="flex items-start gap-3">
                      <div class="w-8 h-8 rounded-full border-2 border-border overflow-hidden bg-bgElevated flex-shrink-0">
                        {% if reply.author.profile %}
                          {% if reply.author.profile.avatar_file %}
                            <img src="{{ reply.author.profile.avatar_file.url }}" alt="{{ reply.author.username }}" class="w-full h-full object-cover">
                          {% elif reply.author.profile.avatar_url %}
                            <img src="{{ reply.author.profile.avatar_url }}" alt="{{ reply.author.username }}" class="w-full h-full object-cover">
                          {% else %}
                            <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ reply.author.username }}" class="w-full h-full object-cover">
                          {% endif %}
                        {% else %}
                          <img src="{% static 'img/avatar-placeholder.png' %}" alt="{{ reply.author.username }}" class="w-full h-full object-cover">
                        {% endif %}
                      </div>
                      <div class="flex-1 space-y-1">
                        <div class="flex items-center gap-2">
                          <span class="font-semibold text-ink">{{ reply.author.username }}</span>
                          <span class="text-xs text-inkMuted">{{ reply.created_at|date:"d.m.Y H:i" }}</span>
                          {% if reply.author == project.owner %}
                            <span class="text-xs px-2 py-0.5 rounded-btn bg-accent-blue/20 text-accent-blue border border-accent-blue/30">Автор проекта</span>
                          {% endif %}
                        </div>
                        <div class="text-sm text-ink whitespace-pre-wrap">{{ reply.text }}</div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-8 text-inkMuted">
          <p>Пока нет комментариев. Будьте первым!</p>
        </div>
      {% endif %}
    </div>
    
    <script>
      function toggleReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        if (form) {
          form.classList.toggle('hidden');
        }
      }
    </script>
  </div>

  <!-- Дополнительная информация -->
  <div class="glass-panel p-6 md:p-8 space-y-4">
    <div class="flex items-center gap-3 flex-wrap text-sm text-inkMuted">
      <span>Раздел: <span class="text-ink font-medium">{{ project.get_section_display }}</span></span>
      <span>•</span>
      <span>Создан: {{ project.created_at|date:"d.m.Y" }}</span>
    </div>
  </div>

  <!-- Кнопка назад -->
  <div class="flex justify-start">
    <a href="{% url 'home' %}" class="btn-outline px-6 py-3 font-semibold">
      ← Назад к проектам
    </a>
  </div>

</div>
{% endblock %}

